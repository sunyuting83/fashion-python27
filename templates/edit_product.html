{% extends "base.html" %}
    {% block css %}
        <style type="text/css">
            .tab-content {
                margin-bottom: 0px;
                border-top: 1px solid #43A0F2
            }
            .nav-tabs > li.active {
                bottom: -1px;
            }
            
            
            .tab-pane {
                position: relative;
            }
            .tab-pane .remove {
                position: absolute;
                right: 10px;
                top: 10px;
            }
            button[name="savesort"] {
                display: none;
            }
            .ovfHiden{overflow: hidden;height: 100%;}
            .newcolor {display: none}
            div[name="sizeis"] {position: relative;}
            .sizeback {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                background: rgba(255,255,255,.8);
                z-index: 99;
                font-size: 20px;
                text-align: center;
                line-height: 1;
                color:#004e90;
            }
            .sizeback.active {background: rgba(255,255,255,1);z-index: -1}
        </style>
        <link href="https://cdn.bootcss.com/jquery-minicolors/2.2.6/jquery.minicolors.min.css" rel="stylesheet">        

<link rel="stylesheet" type="text/css" href="https://cdn.staticfile.org/bootstrap3-wysiwyg/0.1.0/bootstrap3-wysihtml5.min.css">
</link>
        <script type="text/javascript" charset="utf-8" src="{{url_for('static',filename='admin/js/template.js')}}?v=2.1.1"></script>
<link rel="stylesheet" type="text/css" href="http://fex.baidu.com/webuploader/css/webuploader.css">

    {% endblock %}

    {% block content %}
        {% if this == 'edit' %}
        <div class="container-fluid" id="pcont">
            <div class="page-head">
                <h2>产品管理</h2>
                <ol class="breadcrumb">
                    <li class="active">产品管理</li>
                </ol>
            </div>
            <div class="cl-mcont">

            <div class="col-sm-12 col-md-12">
                <div class="block-flat">
                    <div class="pull-right">
                        <a href="manage_product?pid={{pid}}" type="button" class="btn btn-success"><i class="fa fa-reply"></i> 取消返回</a>
                    </div>
                    <div class="header">
                        <h3>修改产品<small>{{thdata.product_class.classname}}</small></h3>
                    </div>
                    <div class="content">
                        <form class="form-horizontal group-border-dashed" action="/manage/edit_product?pid={{pid}}&id={{thdata.proid}}" method="post" name="edit_product" style="border-radius: 0px;">
        {% else %}
        <div class="container-fluid" id="pcont">
                <div class="page-head">
                    <h2>产品管理</h2>
                    <ol class="breadcrumb">
                        <li class="active">产品管理</li>
                    </ol>
                </div>
                <div class="cl-mcont">

                <div class="col-sm-12 col-md-12">
                    <div class="block-flat">
                        <div class="pull-right">
                            <a href="manage_product?pid={{pid}}" type="button" class="btn btn-success"><i class="fa fa-reply"></i> 取消返回</a>
                        </div>
                        <div class="header">
                            <h3>添加产品<small name="class"></small></h3>
                        </div>

                        <div class="content">
                            <form class="form-horizontal group-border-dashed" action="/manage/add_product?pid={{pid}}" method="post" name="add_product" style="border-radius: 0px;" parsley-validate novalidate>

        {% endif %}


                    
                            {{ form.hidden_tag() }}
                            <div class="form-group">
                                <label class="col-sm-3 control-label">产品分类</label>
                                <div class="col-sm-6">
                                    <div class="downList1" style="width: 100%">
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">产品名称</label>
                                <div class="col-sm-6">
                                    {{ form.proname }}
                                    {% for error in form.errors.proname %}
                                        <p style="color:red;">[-] {{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">价格</label>
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        <span class="input-group-addon">$</span>
                                        {{ form.price }}
                                        {% for error in form.errors.price %}
                                            <p style="color:red;">[-] {{ error }}</p>
                                        {% endfor %}
                                        <span class="input-group-addon">.00</span>
                                    </div>
                                </div>
                            </div>
                            <div id="recomm">
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">简单介绍</label>
                                <div class="col-sm-6">
                                    {{ form.text_centont }}
                                    {% for error in form.errors.text_centont %}
                                        <p style="color:red;">[-] {{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <!-- 这里是尺码 -->

                            <!-- <div class="form-group" name="sizelist">
                                <label class="col-sm-3 control-label">尺码</label>
                                <div class="col-sm-6">
                                    
                                    <div class="radio"> 
                                        <label> <input type="checkbox" {% if this == 'add' %}checked{% endif %} name="size" id="size" value="S" /> S</label>
                                    </div>
                                    <div class="radio"> 
                                        <label> <input type="checkbox" {% if this == 'add' %}checked{% endif %} name="size" id="size" value="M" /> M</label>
                                    </div>
                                    <div class="radio"> 
                                        <label> <input type="checkbox" {% if this == 'add' %}checked{% endif %} name="size" id="size" value="L" /> L</label>
                                    </div>
                                    <div class="radio"> 
                                        <label> <input type="checkbox" {% if this == 'add' %}checked{% endif %} name="size" id="size" value="XL" /> XL</label>
                                    </div>
                                    <div class="radio"> 
                                        <label> <input type="checkbox" name="size" id="size" value="XXL" /> XXL</label>
                                    </div>
                                    <div class="radio"> 
                                        <label> <input type="checkbox" name="size" id="size" value="XXXL" /> XXXL</label> 
                                    </div>
                                </div>
                            </div> -->

                            <div>
                            {% for s in sizelist %}
                                <div name="sizeis" data-title="{{s.size_title}}" data-size="{{s.size}}"></div>
                            {% endfor %}
                            </div>

                            {% if this == 'add' %}
                            <div class="form-group">
                                <label class="col-sm-3 control-label">颜色</label>
                                <div class="col-sm-6">
                                    <button type="button" name="addcolor" class="btn btn-warning btn-rad"><i class="fa fa-plus-circle"></i> 添加一组颜色</button>
                                </div>
                            </div>
                            <div class="form-group newcolor">
                            </div>
                            {% else %}
                            <div class="form-group">
                                <label class="col-sm-3 control-label">颜色</label>
                                <div class="col-sm-6">
                                    <button type="button" name="addcolor" class="btn btn-warning btn-rad"><i class="fa fa-plus-circle"></i> 添加一组颜色</button>
                                </div>
                            </div>
                            <div class="form-group newcolor" style="display: block">
                                

                                    
                                {% for color in thdata.colors %}
                                <div name="colors" style="height:100px;padding:10px 0;border-bottom:1px solid #ddd">
                                       <div class="col-sm-3 text-right">
                                            <img src=""></div>
                                       <div class="col-sm-6">
                                            <h5>{{color.colortitle}}</h5>
                                            <h5>
                                                     <div style="width:80px;height:8px;background:{{color.color}}"></div>
                                            </h5>
                                            <h5>产品编号：{{color.number}}</h5>
                                       </div>
                                       <div class="col-sm-3">
                                            <button type="button" name="editcolor" class="btn btn-info btn-rad">编辑这组颜色</button>
                                            <button type="button" name="delcolor" class="btn btn-danger btn-rad">删除这组颜色</button>
                                       </div>
                                       <input type="hidden" name="colorid" id="colorid" value="{{color.id}}" />
                                       <input id="colortitle" name="colortitle" type="hidden" value="{{color.colortitle}}">
                                       <input type="hidden" id="color" name="color" value="{{color.color}}" />
                                       <input type="hidden" id="number" name="number" value="{{color.number}}" />
                                       <input type="hidden" name="picid" id="picid" value="" />
                                       <input type="hidden" name="cover" id="cover" value="{{color.cover}}" />
                                       {% for pic in color.colorpic|sort(attribute='sort') %}
                                       <span data-picides="{{pic.id}}" name="piclist" data-thsrc="{{pic.picurl}}"></span>
                                       {% endfor %}
                                </div>
                                {% endfor %}
                                
                            </div>
                            {% endif %}
                            <div class="form-group">
                                <label class="col-sm-3 control-label">尺码表</label>
                                <div class="col-sm-6">
                                    {% if this == 'add' %}
                                    <img src="" name="sizeimg">
                                    <button type="button" name="sizetable" class="btn btn-info btn-rad"><i class="fa fa-pencil"></i> 点击制作</button>
                                    {% else %}
                                    <img src="{{thdata.size_table}}" name="sizeimg">
                                    <button type="button" name="sizetable" class="btn btn-info btn-rad"><i class="fa fa-pencil"></i> 重新制作</button>
                                    {% endif %}
                                    
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">上传推荐封面图</label>
                                {% if this == 'edit' %}
                                <div class="col-sm-6">
                                    {% if covers != '0' and covers !='' %}
                                        <img src="" name="oldpic" data-img="{{thdata.covers_url.picurl}}">
                                    {% endif %}
                                    <div id="picker">重新选择图片</div>
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-info" role="progressbar" style="width:0%;"></div>
                                    </div>
                                    
                                </div>
                                {% else %}
                                <div class="col-sm-6">
                                    <div id="picker">请选择</div>
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-info" role="progressbar" style="width:0%;"></div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="form-group" name="showimg" style="display: none">
                                <div class="col-sm-12">
                                    <img src="" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">洗涤说明</label>
                                <div class="col-sm-6" name="washlist">
                            {% if washlist %}
                                {% for wash in washlist %}
                                    <div class="radio"> 
                                        <label> <input type="checkbox" {% if this == 'add' %}checked{% endif %} name="washid" id="{{wash.id}}" value="{{wash.id}}" /><img src="{{wash.icon}}" style="width: 20px;margin-left: 10px;" /> {{wash.text}}</label> 
                                    </div>
                                {% endfor %}
                            {% endif %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">模特身高</label>
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        {{ form.model_height }}
                                        {% for error in form.errors.model_height %}
                                            <p style="color:red;">[-] {{ error }}</p>
                                        {% endfor %}
                                        <span class="input-group-addon">厘米</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">面料</label>
                                <div class="col-sm-6">
                                    {{ form.fabric }}
                                    {% for error in form.errors.fabric %}
                                        <p style="color:red;">[-] {{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">里料</label>
                                <div class="col-sm-6">
                                    {{ form.lining }}
                                    {% for error in form.errors.lining %}
                                        <p style="color:red;">[-] {{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">单件净重</label>
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        {{ form.weights }}
                                        {% for error in form.errors.weights %}
                                            <p style="color:red;">[-] {{ error }}</p>
                                        {% endfor %}
                                        <span class="input-group-addon">g</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">单件毛重</label>
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        {{ form.the_net }}
                                        {% for error in form.errors.the_net %}
                                            <p style="color:red;">[-] {{ error }}</p>
                                        {% endfor %}
                                        <span class="input-group-addon">g</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">货期-首单</label>
                                <div class="col-sm-6">
                                    {{ form.first_order }}
                                    {% for error in form.errors.first_order %}
                                        <p style="color:red;">[-] {{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">货期-翻单</label>
                                <div class="col-sm-6">
                                    {{ form.again_order }}
                                    {% for error in form.errors.again_order %}
                                        <p style="color:red;">[-] {{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">运输周期-海运</label>
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        {{ form.shipping }}
                                        {% for error in form.errors.shipping %}
                                            <p style="color:red;">[-] {{ error }}</p>
                                        {% endfor %}
                                        <span class="input-group-addon">天</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">运输周期-空运</label>
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        {{ form.flying }}
                                        {% for error in form.errors.flying %}
                                            <p style="color:red;">[-] {{ error }}</p>
                                        {% endfor %}
                                        <span class="input-group-addon">天</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">产地</label>
                                <div class="col-sm-6">
                                    {{ form.place }}
                                    {% for error in form.errors.place %}
                                        <p style="color:red;">[-] {{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">可见性</label>
                                <div class="col-sm-6">
                                    {{ form.display }}
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-offset-2 col-sm-10">
                                    {{ form.submit }}
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                <ul name="messages" style="display: none">
                    {% for message in messages %}
                    <li data-message="{{ message }}"></li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% endwith %}
                    
            </div>
            

        </div>
    </div>
    
    {% if recommend %}
        {%raw%}
        <script type="text/html" id="Recommend">
            {{each menus}}
            <div class="form-group">
                <label class="col-sm-3 control-label">{{$value.titles}}</label>
                <div class="col-sm-6">
                    <label class="radio-inline"> <input type="radio" checked name="news_p" value="0" class="icheck" /> 无</label>
                    {{each $value.children}}
                    <label class="radio-inline"> <input type="radio" name="news_p" value="{{$value.id}}" class="icheck" /> {{$value.titles}}</label>
                    {{/each}}
                </div>
            </div>
            {{/each}}
        </script>
        {%endraw%}
    {% else %}
        {%raw%}
        <script type="text/html" id="Recommend">
            <h3>没有数据</h3>
        </script>
        {%endraw%}
    {% endif %}

    
 
    

    {% endblock %}
    {% block js %}
<script src="https://cdn.bootcss.com/jquery-minicolors/2.2.6/jquery.minicolors.min.js"></script>
    <script src="{{url_for('static',filename='admin/js/drag-arrange.js')}}"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/wysihtml5/0.3.0/wysihtml5.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/bootstrap3-wysiwyg/0.1.0/bootstrap3-wysihtml5.min.js"></script>
<script src="https://cdn.staticfile.org/parsley.js/2.1.3/parsley.min.js"></script>
    <script src="{{url_for('static',filename='admin/js/jquery.parsley/i18n/messages.zh_cn.js')}}" type="text/javascript"></script>
<script src="http://cdn.staticfile.org/webuploader/0.1.0/webuploader.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function(){
            $('#some-textarea').wysihtml5();

            // 获取分类数据并使用template渲染
            var classlist = {{recommend|safe}};
            // console.log(classlist);
            var data = {
                menus : classlist
            }
            var html = template('Recommend', data);
            document.getElementById('recomm').innerHTML = html;

            var selectList = {{classifylist|safe}};
            var dataList = {
                "results":selectList,
                "paginate": {
                    "more": false
                }
            };


            $('[name="news_p"]').iCheck({
                checkboxClass: 'iradio_square-blue checkbox',
                radioClass: 'iradio_square-blue'
            });

            // 尺码
            $('[name="sizeis"]').each(function(index, el) {
                var sizeall = $(this).data('size');
                var sizetitle = $(this).data('title');
                var sizeStrs = new Array(); //定义一数组 
                sizeStrs = sizeall.split(","); //字符分割
                var sTemplate = '';
                for (var i = 0; i < sizeStrs.length; i++) {
                    sTemplate += '<div class="checkbox-inline">'
                                    +'    <label> <input type="checkbox" name="size" id="size" value="'+sizeStrs[i]+'" /> '+sizeStrs[i]+'</label>'
                                    +'</div>';
                };
                var sizeTemplate = '<div class="sizeback">点击使用这组</div>'
                                +'<div class="form-group" name="sizelist">'
                                +'<label class="col-sm-3 control-label">'+sizetitle+'</label>'
                                +'<div class="col-sm-6">'
                                +''+sTemplate+''
                                +'</div>';
                $(this).html(sizeTemplate);

                $('[name="size"]').iCheck({
                    checkboxClass: 'icheckbox_square-blue checkbox',
                    radioClass: 'icheckbox_square-blue'
                });

                $(this).click(function(event) {
                    $(this).children('.sizeback').addClass('active');
                    $(this).siblings('[name="sizeis"]').children('.sizeback').removeClass('active');
                    $('#size').val('');
                    $(this).siblings('[name="sizeis"]').find('[name="size"]').iCheck('uncheck');
                    SizeId = [];
                });
            });
            

            $(".downList1").select2({
                 data: dataList,
                 placeholder:'请选择',//默认文字提示
                 language: "zh-CN",//汉化
                 allowClear: true//允许清空
            });
            $(".downList1").on("select2-selecting",function(e){
                //console.log(e.object.children.length);
                if(e.object.children.length != 0){
                    layer.alert('请选择小类');
                }else {
                    var val = e.val;
                    $('#pid').val(val);
                }
            });

            var massage = $('[name="messages"]').children('li').data('message');
            if(massage){
                // $.gritter.add({
                //     title: '修改成功',
                //     text: massage,
                //     class_name: 'success'
                // });
                // $(function () {
                //     setTimeout(ChangeTime, 1000);
                // });
                layer.alert('添加成功', function(index){
                  window.location.href = "/manage/manage_product?pid={{pid}}";
                });
            }else if(massage == null){

            }
            function ChangeTime() {
                var time;
                time = $("#time").text();
                time = parseInt(time);
                time--;
                if (time <= 0) {
                    window.location.href = "/manage/manage_product?pid={{pid}}";
                } else { 
                    $("#time").text(time); 
                    setTimeout(ChangeTime, 1000); 
                } 
            };

            // 加分类名称
            // 获取传来的排序参数
            var cname = decodeURI(getUrlParam("cname"));
            if(cname != null){
                $('[name="class"]').text(cname);
            };

            // 尺码表制作
            $('[name="sizetable"]').click(function(event) {
                
                layer.open({
                    type: 2,
                    title: '尺码制作表',
                    shadeClose: true,
                    shade: 0.8,
                    maxmin: true, //开启最大化最小化按钮
                    area: ['893px', '600px'],
                    content: "{{url_for('static',filename='admin/js/sizetable/index.html')}}"
                });
            });
            var WashId = [];
            var SizeId = [];
            {% if this == 'add' %}
            // 洗涤说明写入字段
            $('input:checkbox[name="washid"]').each(function(index, el) {
                var spCodesTemp = $(this).val();
                WashId.push(spCodesTemp);
                $('#wash').val(WashId);
            });
            // 尺寸写入字段
            $('input:checkbox[name="size"]').each(function(index, el) {
                if($(this).is(':checked')) {
                    var spCodesTemp = $(this).val();
                    SizeId.push(spCodesTemp);
                    $('#size').val(SizeId);
                    // console.log(SizeId);
                }
            });
            {% endif %}

            
            {% if this == 'edit' %}
                // 分类复制
                var pid = $('#pid').val();
                // console.log(pid);
                $('.downList1').select2('val',pid);
                // 获取picid数组和第一图片
                $('[name="colors"]').each(function(index, el) {
                    var picids = [];
                    var piclan = $(this).find('[name="piclist"]').length;
                    // console.log(piclan);
                    $(this).find('[name="piclist"]').each(function(index, el) {
                        var thisid = $(this).data('picides');
                        picids.push(thisid);
                        // 获取第一个图片
                        var imgs = new Array;
                        var img = $(this).eq(0).data('thsrc');
                        imgs = img.split(","); 
                        $(this).eq(0).siblings('.text-right').find('img').attr('src',imgs[3]);
                    });
                    $(this).find('#picid').val(picids);
                });

                // 洗涤说明修改部分
                var thwash = "{{thdata.wash}}";
                var strs = new Array(); //定义一数组 
                strs = thwash.split(","); //字符分割
                washid = [];
                for (i = 0; i < strs.length ;i++ ) { 
                    washid.push(strs[i]);
                    WashId.push(strs[i]);
                };
                $('[name="washlist"]').find('input[name="washid"]').each(function(index, el) {
                    var _this = $(this);
                    var thid = $(this).attr('id');
                    // console.log(washid,thid);
                    // FilterData(washid,thid,_this);
                    if ($.inArray(thid, washid) != -1) {
                        _this.iCheck('check');
                    }
                });
                $('#wash').val(washid);
                // console.log(washid);


                // 尺寸修改部分
                
                var thsize = "{{thdata.size}}";
                var strs = new Array(); //定义一数组 
                strs = thsize.split(","); //字符分割
                sizeid = [];
                for (i = 0; i < strs.length ;i++ ) { 
                    sizeid.push(strs[i]);
                    SizeId.push(strs[i]);
                };
                $('[name="sizelist"]').find('input[name="size"]').each(function(index, el) {
                    var _this = $(this);
                    var thid = $(this).val();
                    // console.log(sizeid,thid,$.inArray(thid, sizeid));
                    // $.inArray(thid, sizeid) 检查数组中是否包含某个字符串。包含的返回排序，不包含的返回负数
                    if ($.inArray(thid, sizeid) != -1) {
                        _this.iCheck('check');
                    }
                    // FilterData(sizeid,thid,_this);
                });

                var np = $('#new_p').val();
                $('[name="news_p"]').each(function(index, el) {
                    var _this = $(this);
                    var thid = $(this).val();
                    // console.log(thid,np);
                    if (thid == np) {
                        _this.iCheck('check');
                    }
                });
            
            {% endif %}
            $('input:radio[name="news_p"]').on('ifChanged', function(event){
                var newp = $(this).val();
                $('#new_p').val(newp);
            });
            $('.radio-inline').click(function(event) {
                var newp = $(this).children('input').val();
                $('#new_p').val(newp);
            });
            // 洗涤说明点选之后
            $('input:checkbox[name="washid"]').on('ifChanged', function(event){ //ifCreated 事件应该在插件初始化之前绑定 
                var spCodesTemp = $(this).val();
                if($(this).is(':checked')) {
                    WashId.push(spCodesTemp);
                    // console.log(WashId);
                    $('#wash').val(WashId);
                }else {
                    WashId = remove(WashId,spCodesTemp);
                    $('#wash').val(WashId);
                }
            });
            // 尺寸点选之后
            $('input:checkbox[name="size"]').on('ifChanged', function(event){ //ifCreated 事件应该在插件初始化之前绑定 
                var spCodesTemp = $(this).val();
                if($(this).is(':checked')) {
                    SizeId.push(spCodesTemp);
                    // console.log(SizeId);
                    $('#size').val(SizeId);
                }else {
                    SizeId = remove(SizeId,spCodesTemp);
                    $('#size').val(SizeId);
                }
            });
            

            // 添加人和所在部门
            $('#creatorid').val("{{ current_user.id }}");
            $('#oldpid').val("{{ pid }}");
            $('#teamid').val("{{ current_user.teamid }}");
            // 添加pid
            $('#pid').val("{{ pid }}");
            {% if this == 'add' %}
            $('.downList1').select2('val','{{ pid }}');
            {% endif %}

            // 添加一组颜色
            $('[name="addcolor"]').click(function(event) {
                var thight = $(this).offset().top - 80;
                $('html,body').addClass('ovfHiden');
                layer.open({
                    type: 2,
                    title: '添加一组颜色',
                    shadeClose: false,
                    closeBtn: 0,
                    shade: 0.8,
                    maxmin: true, //开启最大化最小化按钮
                    area: ['80%', '70%'],
                    content: "{{url_for('static',filename='admin/js/addcolor/index.html')}}",
                    success: function(layero, index){
                        var body = layer.getChildFrame('body',index);//建立父子联系
                        var iframeWin = window[layero.find('iframe')[0]['name']];
                        // body.find('#fatherid').val(i);
                    },
                    end: function(){
                        $('html,body').removeClass('ovfHiden').animate({  
                            scrollTop: thight
                        }, 0);
                        if($('[name="colors"]').length >= 1) {
                            $('#submit').removeAttr("disabled");
                        }
                    }
                });
            });
            {% if this == 'add' %}
            // 删除颜色组
            $('.newcolor').delegate('[name="delcolor"]','click',function(){
                var picids = $(this).parents('.col-sm-3').siblings('#picid').val();
                
                var n = new Array;
                n = picids.split(",");
                for (var i = 0; i < n.length; i++) {
                    delpics(n[i]);
                };
                $(this).parents('[name="colors"]').remove();
            });
            {% endif %}
            {% if this == 'edit' %}
            // 删除颜色组
            $('.newcolor').delegate('[name="delcolor"]','click',function(){
                var colorid = $(this).parents('.col-sm-3').siblings('#colorid').val();
                var thiss = $(this);
                if(colorid.length>0) {
                    var geturl = "/manage/del_colors";
                    var getdata = {
                        id: colorid
                    };
                    var post = false;
                    var active = '删除';
                    delcolors(active,geturl,getdata,false,thiss);
                }else{
                    $(this).parents('[name="colors"]').remove();
                }
            });
            {% endif %}

            // 编辑颜色组
            $('.newcolor').delegate('[name="editcolor"]','click',function(){
                var thight = $(this).offset().top - 80;
                $('html,body').addClass('ovfHiden');
                var _thiss = $(this).parents('.col-sm-3');
                var colortitle = _thiss.siblings('#colortitle').val();
                var color = _thiss.siblings('#color').val();
                var number = _thiss.siblings('#number').val();
                var picid = _thiss.siblings('#picid').val();
                var cover = _thiss.siblings('#cover').val();
                var pindex = _thiss.parents('[name="colors"]').index();
                layer.open({
                    type: 2,
                    title: '修改颜色组',
                    shadeClose: false,
                    closeBtn: 0,
                    shade: 0.8,
                    maxmin: true, //开启最大化最小化按钮
                    area: ['80%', '70%'],
                    content: "/static/admin/js/addcolor/edit.html?eq="+pindex+"&picid="+picid,
                    success: function(layero, index){
                        var body = layer.getChildFrame('body',index);//建立父子联系
                        var iframeWin = window[layero.find('iframe')[0]['name']];
                        body.find('#colortitle').val(colortitle);
                        body.find('#hue-demo').val(color);
                        body.find('#number').val(number);
                        body.find('#picid').val(picid);
                        body.find('#cover').val(cover);
                    },
                    end: function(){
                        $('html,body').removeClass('ovfHiden').animate({  
                            scrollTop: thight
                        }, 0);
                        if($('[name="colors"]').length >= 1) {
                            $('#submit').removeAttr("disabled");
                        }
                    }
                });
            });
            
            //循环判断数组a里的元素在b里面有没有，有的话checkbox点选
            function FilterData(a,b,$this) {
                var c=b.toString();
                for(var i=0;i<a.length;i++) {
                    if(c.indexOf(a[i].toString())>-1) {
                        $this.iCheck('check');
                    }     
                } 
            };

            // 弹出函数
            function delcolors(active,geturl,getdata,post=false,$this){
                // console.log($this);
                layer.confirm('您确定要'+active+'？', {
                    btn: ['确定'+active,'取消'] //按钮
                }, function(){
                    var activate = '';
                    if(post == true) {
                        activate    = 'post';
                        traditional = true;
                    }else{
                        activate    = 'get';
                        traditional = false;
                    };
                    $.ajax({ 
                        type: activate, 
                        url: geturl,
                        data: getdata,
                        dataType: 'json',
                        traditional: traditional,
                        beforeSend:function(XMLHttpRequest){ 
                        }, 
                        success:function(data,textStatus){
                            // console.log($thiss);
                            if(data.state == 'ok'){
                                layer.msg(active+'成功', {icon: 1});
                                $this.parents('[name="colors"]').remove();
                            }else{
                                layer.confirm(active+'失败', {
                                    btn: ['点击刷新']
                                },function(){
                                    return window.location.reload()
                                });
                            }
                        }, 
                        complete:function(XMLHttpRequest,textStatus){ 
                            //HideLoading(); 
                        }, 
                        error:function(){ 
                            //请求出错处理 
                        } 
                    });
                });
            };


            // 旧图片显示
            var pic_element = $('[name="oldpic"]')
            if(pic_element.length>0){
                var imgad = pic_element.data('img');
                
                var strs= new Array(); //定义一数组 
                strs=imgad.split(","); //字符分割
                for (i=0;i<strs.length ;i++ ) { 
                }
                var imgout = strs[2];
                if(imgout==null){
                    pic_element.remove();
                }else {
                    pic_element.attr('src',imgout)
                }
                
            };

            // 图片上传控件
            $('.progress').hide();

            var task_id = WebUploader.Base.guid();
            var uploader = WebUploader.create({
                swf: 'http://cdn.staticfile.org/webuploader/0.1.0/Uploader.swf',
                server: '/manage/upload',
                pick: '#picker',
                multiple: false,
                accept: {
                        title: 'Images',
                        extensions: 'gif,jpg,jpeg,bmp,png',
                        mimeTypes: 'image/jpg,image/jpeg,image/png,image/gif'
                    },
                auto: true,
                threads: 3,
                duplicate: true,
                formData: {
                    task_id: task_id,
                },
            });
            uploader.on('startUpload', function() {
                $('#progress').show();
                $('.progress-bar').css('width', '0%');
                $('.progress-bar').text('0%');
                $('.progress-bar').removeClass('progress-bar-danger progress-bar-success');
                $('.progress-bar').addClass('active progress-bar-striped');
                $('.progress').show();

                // 修改轮显时，判断旧图片显示
                var pic_element = $('[name="oldpic"]')
                if(pic_element.length>0){ 
                    pic_element.hide();
                };

                // 多次选择图片，删除之前图片
                var needimg = $('[name="showimg"]').find('img').attr('src');
                var picid = $('#covers').val();
                // console.log(needimg,picid);

                if(needimg.length>0 && picid != null && picid != ''){
                    console.log('有图片');
                    $.ajax({
                         url: '/manage/del_pic?picid='+picid,
                         dataType: 'json',
                         method: 'GET',
                         success: function(data) {
                            // console.log(data)
                         },
                         error: function(xhr) {
                             // 导致出错的原因较多，以后再研究
                             // console.log(xhr)
                         }
                    });
                }


            });
            uploader.on('uploadProgress', function(file, percentage) {
                $('.progress-bar').css('width', percentage * 100 - 1 + '%');
                $('.progress-bar').text(Math.floor(percentage * 100 - 1) + '%');
            });
            uploader.on('uploadSuccess', function(file,response) {
                $('.progress-bar').css('width', '100%');
                $('.progress-bar').text('100%');
                $('.progress-bar').addClass('progress-bar-success');
                $('.progress-bar').text('上传完成');
                // console.log(response.image_path);
                $('[name="showimg"]').show();

                var imgurl = response.image_path;
                var imgid  = response.imgid;
                $('#covers').val(imgid);
                // console.log(imgurl);
                var strs= new Array(); //定义一数组 
                strs=imgurl.split(","); //字符分割
                for (i=0;i<strs.length ;i++ ) { 
                }
                var imgout = strs[2];

                $('[name="showimg"]').find('img').attr({
                    src: imgout
                });
            });
            uploader.on('uploadError', function(file) {
                $('.progress-bar').css('width', '100%');
                $('.progress-bar').text('100%');
                $('.progress-bar').addClass('progress-bar-danger');
                $('.progress-bar').text('上传失败');
            });
            uploader.on('uploadComplete', function(file) {
                $('.progress-bar').removeClass('active progress-bar-striped');
            });

        });
    </script>


    {% endblock %}

